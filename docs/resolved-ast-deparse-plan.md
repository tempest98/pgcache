# Plan: Use Resolved AST for Cache Query Generation

## Completed

1. **Added `table_alias` field to `ResolvedColumnNode`** - Tracks the alias used in the query for deparsing purposes.

2. **Updated column resolution** - `column_resolve` and `select_columns_resolve` now populate `table_alias` from the resolution scope.

3. **Custom equality/hash for `ResolvedColumnNode`** - `PartialEq` and `Hash` implementations exclude `table_alias` since it's only for display, not identity.

4. **Implemented `Deparse` for resolved AST types** - All resolved types now support deparsing with proper alias handling.

5. **Added tests** - Comprehensive tests for deparse functionality.

## Remaining Work

### Update `query_cache.rs` to use resolved AST deparse

Currently, cache queries are generated by deparsing the original AST (`SelectStatement`). This should be changed to use the resolved AST (`ResolvedSelectStatement`) which provides:
- Fully qualified table names (schema.table)
- Proper alias handling
- Expanded column lists for SELECT *

#### Files to modify

- `pgcache/src/cache/query_cache.rs`

#### Key changes

1. **`query_cache_fetch` function** (~line 155-187)
   - Currently deparses modified AST to fetch from origin
   - Change to use `CachedQuery.resolved` and call `resolved.deparse()`

2. **`cache_upsert_with_predicate_sql` function** (~line 812-864)
   - Generates INSERT with predicate from AST
   - Update to use resolved AST for predicate generation

3. **Transform functions in `transform.rs`**
   - May need resolved AST versions of:
     - `query_select_replace` - Replace SELECT columns
     - `query_table_replace_with_values` - Replace table source with VALUES

#### Considerations

- The resolved AST already stores alias information, so deparsed SQL will use aliases where the original query used them
- For queries without aliases, the deparsed SQL will use fully qualified `schema.table.column` format
- SELECT * is expanded to explicit column list in the resolved AST

#### Testing

- Existing integration tests should continue to pass
- May need to update expected SQL strings in tests if format changes
